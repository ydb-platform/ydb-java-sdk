name: SLO JDBC

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  jdbc-slo-test:
    name: JDBC SLO Test
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Start YDB Docker container
      - name: Start YDB container
        run: |
          docker run -d --name ydb-local -p 2135:2135 yandex/ydb-local:latest
          echo "Waiting for YDB to start..."
          for i in {1..20}; do
            nc -zv localhost 2135 && echo "âœ… YDB is up!" && break
            echo "Waiting..."
            sleep 3
          done

      # 3. List databases to verify container
      - name: List YDB databases
        run: |
          docker exec ydb-local ydb-cli --endpoint localhost:2135 list-databases

      # 4. Create test database
      - name: Create test database
        run: |
          docker exec ydb-local ydb-cli --endpoint localhost:2135 --database /Root create-database testdb || echo "Database exists"

      # 5. Set up JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 6. Build modules without tests
      - name: Build slo modules
        run: ./mvnw clean install -DskipTests

      # 7. Run Simple JDBC Test
      - name: Run Simple JDBC Test
        env:
          YDB_JDBC_URL: jdbc:ydb:grpc://localhost:2135/Root
        run: ./mvnw test -pl slo/simple-jdbc-test